# 概念
## 进程
进程是一个程序执行的实例，在内核中可以叫做任务(task)或线程(thread)。  
Linux采用“轻量级进程”作为多线程。两个轻量级进程(线程)之间可以进行一些资源的共享，如地址空间，打开的文件等。  
Linux中，一个线程组就是一组轻量级进程实现的多线程应用。  
内核通过**进程描述符(process descriptor,也叫做task_struct)**来描述一个进程的详细信息.如地址空间，进程优先级，状态等  
![进程描述符](https://github.com/noffff/Notes/blob/master/Ops/ops/%E8%BF%9B%E7%A8%8B/process_descriptor.jpg)  
`进程描述符`中的state字段描述了进程当前所处的状态，状态间互相互斥，该状态种类由一组字符串组成。  
- TASK_RUNNING
可运行状态，正在运行或准备执行
- TASK_INTERRUPTIBLE
可中断的等待状态。进程被挂起，直到有一条件变成真触发，产生一个硬件中断，释放进程正等待的系统资源，或传递一个信号给进程。
- TASK_UNINTERRUPTIBLE
不可中断的等待状态。当打开一个设备文件，相应的驱动会去探测相应的设备，这个过程时不可中断的等待状态，进程进入临界区。
- TASK_STOPPED
暂停状态，进程执行被暂停。收到SIGDTOP，SIGTSTP，SIGTTIN或SIGTTOU信号后，进入该状态，
- TASK_TRACED
跟踪状态。当一个进程被另一个进程监控时。  
另外两种特殊进程状态，可以放在`process descriptor`也可以放在`exit_state`字段中。  
- 僵尸进程(EXIT_ZOMBIE)
进程的执行被终止，但父进程还没有执行`wait4()`或`waitpid()`的系统调用来返回有关死亡进程的信息。在这个时间段，内核不会清除已结束进程的进程描述符中的数据。
- 僵死撤消状态(EXIT_DEAD)
> 内核通过`set_task_state`和`set_current_state`宏分别设置指定进程状态和当前执行进程的状态  
在进程描述符中的pid段中存放PID，PID一般按照顺序递增，不过PID有上限。64位中可以将PID上限调为4194304。  
Linux将不同的PID与进程一一关联，并且在内核中有一个pidmap_array的表来记录已分配和未分配的PID号。  
该值被放在进程描述符的tgid字段，可以通过`getpid()`调用当前进程的tgid值。  
进程都是有生命周期的，所以进程描述符放在动态内存中。  
进程描述符由两部分组成
- 线程描述符thread_info
- 内核态的进程堆栈  
内核通过`alloc_thread_info`和`free_thread_info`宏为进程描述符和内存堆栈分配内存区。 
## 线程
进程的执行单元，也被称为轻量级进程
同一线程组(一个进程衍生出来的多个线程)内的线程会有同一PID，该PID使用和线程组头线程相同PID(该组中第一个轻量级进程的PID)。  

## 进程优先级
分为两部分的，静态(实时，不可修改)优先级和动态(非实时)  
优先级越高越有机会被CPU执行  
静态优先级最高99最低0与系统优先级0、99对应。  
只能通过调用进程的nice来改变静态优先级  
nice支持19(最低)到-20(最高优先级)，默认0   
> 静态优先级数高，其系统优先级越低，分配的时间片就越小
动态优先级，是内核基于进程行为特征临时调整优先级的体现    

## 进程内存段
进程执行时，内核给其分配一部分内存区域。进程在该区域工作  
内核对进程动态分配内存，进程的内存区域由以下段组成  
- 文本段
存储可执行代码
- 数据段
  - 数据 存储初始化数据
  - BSS  存储零初始化数据，数据被初始化为0
  - 堆   `malloc()`根据需求动态分配内存
- 堆栈段
局部变量、函数参数、返回的存储函数存放区域


## CPU调度
