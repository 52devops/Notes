# TCP
靠谱的传输协议，首部20字节<br>
强制要求校验和,面向连接，控制避免分片
## TCP可靠性
应用数据被TCP切割为适合TCP传输的数据块，TCP封装后的数据称作**报文段/段**。该段的长度在三次握手时确立，双方各自汇报自己的MSS，如果有一方不接受，则会使用默认536字节，这样加上20字节IP首部和20字节TCP首部正好是576自己<br>
MSS只有在SYN报文段中才能携带，MSS值是线路MTU减去IP和TCP首部得到<br>
发出段后启动计数器，等待目的端口确认收到这个报文段，如**超时**，会重发。<br>
目的端收到后，会返回一个ACK，该ACK不是立刻发送<br>
TCP自计时行为：ACK的产生与接收到的段之间的间隔时间是一致的
TCP的校验和包括数据和首部，端到端的校验，如果检验和有错TCP将丢弃该报文段并不确认收到该报文段，此举将引起超时重发<br>
TCP能够处理IP数据报到达后的失序问题,将正确顺序交给应用层<br>
通过控制接收端缓冲区/窗口大小来进行流量控制，窗口大小在TCP首部中占16bit，因此窗口最大为65535字节<br>
TCP通过序号对字节进行计数，需要达到2^32-1时从0开始。由此可见序号在TCP首部中占32位，SYN占用一个序号<br>
确认序号包含发送确认一端所期望收到的下一序号<br>发送ACK无代价，因为ACK也是首部的一部分<br>
## 建立连接和结束
建立连接通过三次握手方式<br>
结束通过四次分手<br>
因为TCP是全双工，所以需要四次分手，两端都需要发送一个FIN标准用来结束，如果只有一段发送那么进入半关闭状态，没有发送FIN那端仍可以发送数据，已发送FIN端仍可以接收数据。在主动关闭的一方收到ACK后会进入**TIME_WAIT**<br>
几个状态
- 建立连接
  - 连接端：
    - SYS_SENT
    - ESTABLISHED
  - 被连接端：
    - LISTEN
    - SYS_RCVD
    - ESTABLISHED
- 结束连接
  - 结束端
    - FIN_WAIT1
    - FIN_WAIT2
    - TIME_WAIT
  - 被结束端
    - CLOSE_WAIT
    - LAST_ACK
    - CLOSED
每个TCP报文段最大生存时间为MSL，指在被丢弃前在网络内的最长生存时间。
TIME_WAIT被称为2MSL等待，其MSL为2MSL.就是为了防止ACK丢失，另一端重发FIN，在这个等待时间任何刚到达的报文都会丢弃
平静时间：当节点处于2MSL状态时，发生故障重启。为了防止之前的报文被认为是新连接的包，则在MSL时间内不接受连接。但一般主机重启时间比MSL时间要长的多

##  呼入队列请求
> 服务器调用新进程来处理每个客户的请求。该进程处于被动状态，时刻准备接受连接请求。如果服务器正
处于繁忙状态，客户端请求建立连接时TCP有一下策略：
```
等待连接请求一端有一个固定长度连接队列。队列中连接已经三次握手成功，但应用层没有接受，如果接受
会从移出该队列。
该队列称为backlog，积压值，大小由应用层指定，一般为0-5
一个连接到达时TCP根据当前队列的连接数来决定是否接受该链接。
```
## TCP 数据传输
### 交互数据
每一次传输量较小。可以将每一次(每一字节)或每一行键入的数据作为TCP分组发送<br>
如果每次发送一次节的数据，那么TCP段长41字节(**微小分组**)会特别多，在广域网上太浪费，可能会造成拥塞。<br>Nagle算法解决了该问题，表示在TCP连接上最多只能有一个未被确认的小分组，该分组被确认前不能发送其他小分组。<br>TCP会在不能发送的时候收集这些小分组，将其合并，最终以一个分组发送

### 块数据
块数据两种协议
- 停止等待协议<br>
`发送一个块数据就需要停止发送等待接收方返回一个ACK确认`
- 滑动窗口（通告窗口，接收方用来控制）<br>
> 允许发送方在停止并等待确认前可连续发送多个分组,接收方的ACK序号在**时延定时器**未溢出前是可以积累,未被确认的连接会被标记为**经受时延的确认**，只用回复一个最后接收的数据的序号ACK即可.
窗口大小起始于确认序号字段的值。该值是正期望接收的字节
窗口大小的调节与接收方的TCP缓存有关，TCP窗口在增加两个报文段长度或最大窗口50%大小时发送ack更新。
- PUSH<br>
该标记类似于flush，能够将接收方的TCP缓存信息立刻刷到应用中。两种情况有 缓存填满或PUSH被标记。发送方的发送队列填充满，最后一个报文发送时也带PUSH(PSH)标记
- URG<br>
紧急标志，告知接收端该普通数据流中放置了**紧急数据**。并通过一个16bit的紧急指针来指定一个正偏移量。<br>该偏移量包含TCP首部中的序号字节，以此来标定紧急数据的最后一个字节。
- 慢启动<br>
防止建立连接后，发送方直接发送多个数据段，导致这些段可能被路由缓存等引起速率较慢。<br>
解决方法是用**慢启动**增加一个**拥塞窗口(cnwd)**。拥塞窗口是接收方用来控制流量的。<br>每收到一个ACK，拥塞窗口增加一个报文段(发送方因此可发送报文段数可以逐渐递增，指数增加到最大。最大为填满发送方和接收方的管道被填满。**该增加法为2,4,8...的增加**)<br>发送方选择min(拥塞窗口,通告窗口)发送上限。建立连接时cnwd初始化为1。<br>
- 管道|通道大小|带宽时延乘积<br>
**capacity(bit) =  带宽(b/s) \* RTT**
当上述结果变的非常大时，会暴露TCP局限性。乘积较大时叫做**长肥管道**
- 拥塞<br>
```
当一个大的流量，流入小的接口管道时便会发生。
拥塞时会调用慢启动来解决这个问题。
两种情况判断拥塞：超时和接收到重复的确认
```
- 慢启动与拥塞避免的配合<br>
```
拥塞窗口 cnwd
慢启动门限 ssthresh
拥塞发生时，ssthresh变为(min[cwnd,通告窗口大小])/2
新数据被确认,cwnd增加。cwnd <= ssthresh 正在慢启动。
当超过门限的一半时变为**拥塞避免算法**，收到一个ACK，增加一个cwnd。与慢启动的增加明显不同。
```

## 超时重传
- 定时器种类
  - 重传定时器：使用于希望收到另一端的确认
  - 坚持定时器：使窗口大小信息保持不断流动
  - 保活定时器：可检测到一个空闲连接的另一端何时崩溃或重启
  - 2MSL：测量一个连接处于TIME_WAIT状态的时间
超时重传的重传时间有倍乘关系，被称为**指数退避**。当多次重传无效后会放弃并发送**复位信号**。<br>
首次传输到复位信号传输之间时间差大约为9分钟<br>
- 重传的流程<br>
```
发送方向接收方依次发送A...Z报文段
报文C丢失，但是接收方没有办法直接指出丢失C，只能返回ACK_B,按照现有标准重复发送3个ACK,会确认C丢失，引起重传C报文段。
重传后不会等待ACK。在丢失C后，发送方可能已经发送到N等数据段。这些数据段已经是失序的。等到接收方收到重传报文后，会将TCP放在缓存(TCP接收方的通知窗口中)中的这些数据再一起交给用户进程。并在接下来的ACK中确认这些字节数。
```
> 失序会引发重复的ACK，并且无延迟的发送给发送数据方，让其清楚数据失序，并告知需求的序号。
- 失序两种情况引起
丢失数据段，报文段重新排序<br>
丢失数据段会一直重复发送ACK告知数据发送方<br>
重新排序只会在处理完成前发送1-2个重复的ACK<br>
**快速重传算法**就是使用这个原理，在一般接收到大于3个以上的ACK会判定丢失数据段，触发重传<br>
快速重传不用等待定时器溢出。
> 在TCP超时并重传时，不一定会重传相同的报文段，可能重传一个重新分组的一个较大的报文段。该方法用以提高性能

## TCP坚持定时器
在通告窗口由0变为可以接收值时，接收方会向发送数据方发送一个ACK并携带更新的Win size。<br>
TCP不保证ACK的可靠性，所以为了防止更新ACK挂掉导致双方**傻等**，发送数据方使用**坚持定时器**<br>
来周期性能的向接收方查询(坚持定时器完时发送)，窗口是否增大。这个探查窗口大小的报问叫做**窗口探查**<br>
糊涂窗口综合症。接收方更新通告窗口的值为一个比较小的值，发送方接收到后也不等待大数据段，直接发送一个较小的数据段<br>

## TCP保活定时器
> 为了保证连接不是空置连接，从而采用**保活定时器**
```
保活定时器一般被服务器应用程序使用。用来检测客户机是否崩溃。防止连接永远处于开放状态
服务器：使用保活选项的一方
在双方给定连接的时间内没有反应时服务器端发送一个探查报文。
客户端有以下四种状态：
 客户机正常工作，服务正常：
 客户机崩溃，正则关闭或重启：这种情况下，客户机无响应。服务器会每隔75s发送一次，一共发10次。等到10次后判定关闭连接。
 客户机崩溃已完成重启：服务器收到保活探查的响应，但该响应是复位标志，服务器终止该连接。
 客户机正常，服务不可达：与状态2情况一致
```

## TCP性能和未来
TCP在更快的链路上有一些弊端
长肥网络，capacity较大。TCP在长肥网络上叫做长肥管道
- 局限性
  - TCP 首部窗口大小16bit 窗口最大为65535。浪废了长肥管道的大吞吐
    - 可以通过窗口扩大选项调整为32bit。窗口扩大选项就是通过将**移位器**赋值。Windows size = 65535 * 2^移位器大小
窗口扩大这个参数由主动建立连接的一方在SYN报文中,接收方接收到后才可以发送。如果接收方不发送，那么偏移量为0。
  - 多个分组丢失
  - 等等
> 当带宽达到一定程度时，时延将成为影响的主要成分。时延主要由光速引起。<br>
